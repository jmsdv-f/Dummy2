name: Build Lambda Layers

on:
  push:
    branches:
      - '**'
      - '!main'
    paths:
      - 'infrastructure/**/lambdas/layers/**/requirements.txt'

permissions:
  contents: write

jobs:
  build-layers:
    name: Build and Package Lambda Layers
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Detect changed layers
        id: changed-layers
        run: |
          # For push events, detect changed requirements.txt files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep 'infrastructure/.*/lambdas/layers/.*/requirements.txt' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No requirements.txt files changed"
            echo "layers=" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # Extract unique layer directories
            LAYERS=$(echo "$CHANGED_FILES" | xargs -n1 dirname | sort -u | xargs -n1 basename | tr '\n' ' ')
            echo ""
            echo "Layers to build: $LAYERS"
            echo "layers=$LAYERS" >> $GITHUB_OUTPUT
          fi
      
      - name: Pull AWS Lambda Docker image
        if: steps.changed-layers.outputs.layers != ''
        run: docker pull public.ecr.aws/lambda/python:3.12
      
      - name: Build Lambda layers
        if: steps.changed-layers.outputs.layers != ''
        run: |
          chmod +x scripts/build_layers.sh
          
          echo "=========================================="
          echo "Building Lambda Layers"
          echo "=========================================="
          
          # Build each changed layer
          for layer in ${{ steps.changed-layers.outputs.layers }}; do
            echo ""
            ./scripts/build_layers.sh "$layer" || exit 1
          done
          
          echo ""
          echo "=========================================="
          echo "All layers built successfully!"
          echo "=========================================="
      
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          add: 'infrastructure/*/lambdas/layers/*'
          message: "chore: auto-build Lambda layers [skip ci] (Run: ${{ github.run_number }})"
